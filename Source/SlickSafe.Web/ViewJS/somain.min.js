var somain=function(){function a(){}function b(){var b=lsm.getWebLogonUserID();jshelper.ajaxGet("api/ResourceData/GetLeftMenuList/"+b,null,function(b){if(1===b.Status){var d=b.Entity;a.userPermissionTreeView=d,c(d)}else $.msgBox({title:"Menu / List",content:"读取菜单记录失败！错误信息："+b.Message,type:"error"})})}function c(a){var b=!0,c=!0,d="collapsed",e=" active",f="";$.each(a,function(a,g){var h=g.StyleClass,i=g.ResourceName,j="RESX06Z9-"+g.ID;f=b?d+e:d,$('<li data-toggle="collapse" data-target="#'+j+'" class="'+f+'"><a href="#"><i class="'+h+'"></i> '+i+' <span class="arrow"></span></a></li>').appendTo($("#menu-content"));var k=$('<ul class="sub-menu collapse" id="'+j+'"></ul>').appendTo($("#menu-content"));$.each(g.children,function(a,d){var e={name:"RESX06Z9-"+d.ID,title:d.ResourceName,url:d.UrlAction},f="";b&&c&&(f='class="active"'),$('<li><a href="#" '+f+"data-page='"+JSON.stringify(e)+'\' onclick="somain.showTab(this)">'+d.ResourceName+"</a></li>").appendTo($(k)),c=!1}),b=!1});var g={name:"myprofile",title:"个人资料",url:"profile/index"};$('<li data-target="#'+g.name+'"><a href="#"data-page=\''+JSON.stringify(g)+'\' onclick="somain.showTab(this)"><i class="fa fa-user fa-lg"></i> Profile</a></li>').appendTo($("#menu-content"))}function d(b){a.displayProgressBar(!0);var c=$(b).data("page");$(b).empty(),$(b).load(c,function(){a.displayProgressBar(!1)})}function f(b,c){return""===c?($.msgBox({title:"SlickSafe / Page",content:"指向页面URL字段不存在，请再次确认！",type:"alert"}),!1):void $.ajax({type:"HEAD",url:c,statusCode:{404:function(){$.msgBox({title:"SlickSafe / Page",content:"页面不存在！Error:404 Page Not Found.",type:"alert"})}},success:function(){a.displayProgressBar(!0),BootstrapDialog.show({title:b.toUpperCase(),message:$("<div></div>").load(c,function(){a.displayProgressBar(!1)})})},error:function(){}})}function g(a,b){if(void 0===b||""===b){var c="您没有权限操作，或者程序方法[{0})]未定义，请联系管理员确认！";return $.msgBox({title:"SlickSafe / Page",content:c.formatUnicorn(a),type:"alert"}),!1}jshelper.executeFunctionByName(b,window)}function h(a,b){var c=null;return $.each(a,function(a,d){return(d.ID!==parseInt(b)||(c=d.children,null===c))&&(!(d.children&&d.children.length>0&&(c=h(d.children,b),null!==c))&&(null===c&&void 0))}),c}function i(a,b){var c=!1;return $.each(b,function(b,d){if(d.DataAction===a)return c=!0,!1}),c}return a.tablist=[],a.activeTabName="",a.activeToolButtonType="",a.userPermissionTreeView=null,a.init=function(){function d(){1==c?(a.removeClass("is-open"),a.addClass("is-closed"),c=!1):(a.removeClass("is-closed"),a.addClass("is-open"),c=!0)}var a=$(".hamburger"),c=!1;a.click(function(){d()}),$('[data-toggle="offcanvas"]').click(function(){$("#wrapper").toggleClass("toggled")}),b()},a.showTab=function(b){var c=$(b).data("page"),e=c.name,f=c.title,g=c.url;if(a.activeTabName=e,"mydashboard"===e)return void $("#myTab a:first").tab("show");var h=e+"Tab_",i=$("a[href='#"+h+"'");if(0===i.length){$("#myTab").append($('<li><a href="#'+h+'">'+f+'<button class="close" type="button" title="Remove this page"> ×</button></a></li>'));var j=$('<div class="tab-pane" style="height:700px;width:100%;margin-top:10px;" id="'+h+'" data-page="'+g+'"></div>').appendTo("#divTabContentContainer");a.activeTabContent=j,d(a.activeTabContent),$("#myTab a:last").tab("show")}else a.activeTabContent=$("#"+h),i.tab("show")},a.initPage=function(){$("#myTab").on("click","a",function(a){a.preventDefault(),$(this).tab("show")}),$("#myTab").on("click"," li a .close",function(){$(this).parents("li").children("a").attr("href");$(this).parents("li").remove("li"),$("#myTab a:first").tab("show")}),$("#myTab").tab()},a.addrecord=function(b){a.activeToolButtonType="add",f(a.activeToolButtonType,b)},a.editrecord=function(b){a.activeToolButtonType="edit",f(a.activeToolButtonType,b)},a.deleterecord=function(b){a.activeToolButtonType="delete",g(a.activeToolButtonType,b)},a.refreshrecord=function(){a.activeToolButtonType="refresh",d(a.activeTabContent)},a.displayProgressBar=function(a){a===!0?$("#loading-indicator").show():$("#loading-indicator").hide()},a.checkUserPermission=function(){var b=a.activeTabName.substring(a.activeTabName.lastIndexOf("-")+1).toLowerCase(),c=h(a.userPermissionTreeView,b),d=a.activeTabName+"Tab_",e=$("div#"+d).find("[data-action]");$.each(e,function(a,b){var d=$(b).data("action"),e=i(d,c);e===!1&&$(b).removeClass("btn-info").addClass("btn-warning").attr("onclick","").bind("click",function(a){return a.preventDefault(),$.msgBox({title:"SlickSafe / Page",content:"您当前没有权限操作此功能！",type:"alert"}),!1})})},a}(),accountmgr=function(){function a(){}function b(a){var b=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;return b.test(a)}return a.init=function(){""!=$("#divLoginError").text().trim()&&$("#divLoginError").show(),$("#myLoginForm").bind("ajax:complete",function(){alert("ajax complete..."),""!=$("#hdnWebLogonUserTicket").value()?alert("ticket is here"):alert("not ticket")})},a.ended=function(){alert("ended..."),$("#myLoginForm").bind("ajax:complete",function(){alert("ajax complete..."),""!=$("#hdnWebLogonUserTicket").value()?alert("ticket is here"):alert("not ticket")})},a.register=function(){var a="",c=$("#txtUserName").val(),d=$("#txtPassword").val(),e=$("#txtPasswordConfirmed").val(),f=$("#txtEmail").val();if(void 0==c||0==c.length?a="用户名称不能为空，请重新输入！":c.length<4?a="用户名称长度不能低于4个字符，请重新输入！":void 0==d||void 0==e||d!=e?a="请确认两次输入的密码是否一致！":d.length<6?a="密码长度不能小于6位，请重新输入！":void 0!=f&&0!=f.length&&b(f)||(a="邮箱不能为空或输入错误格式，请重新输入！"),""!=a)return $("#divRegisterError").text(a),$("#divRegisterError").show(),!1;var g={UserName:c,Password:d,EMail:f};ajaxPost(lsm.getApiUrl("Account/Register"),JSON.stringify(g),function(a){1==a.status?window.location="~/User/Profile":($("#divRegisterError").text(a.Message),$("#divRegisterError").show())})},a.sendEMail=function(a){var c="";return void 0!=a&&0!=a.length&&b(a)||(c="邮箱不能为空或输入错误格式，请重新输入！"),""!=c?($("#divSendEMailError").text(c),$("#divSendEMailError").show(),!1):void ajaxPost("/Account/SendEMail",JSON.stringify({EMail:a}),function(a){1==a.status?window.location="/Account/Login":($("#divSendEMailError").text(a.Message),$("#divSendEMailError").show())})},a.loadImage=function(){$.ajax({type:"GET",url:"/CaptchaImage/Index",contentType:"image/GF",success:function(a){var b=new Date;$("#imgCaptcha").attr("src","/CaptchaImage/Index?"+b.getTime())}})},a.changePassword=function(){var a="",b=lsm.getUserIdentity(),c=b.ID,d=b.UserName,e=$("#txtOldPassword").val().trim(),f=$("#txtNewPassword").val().trim(),g=$("#txtNewPasswordConfirm").val().trim();(void 0==f||f.length<6||f!=g)&&(a="密码不符合要求，请重新输入新密码，密码必须为6个以上字母或数字的组合");var h={UserID:c,UserName:d,OldPassword:e,NewPassword:g};ajaxPost("/Account/Password",JSON.stringify(h),function(a){if(a.ID){var b={ID:a.ID,UserName:a.UserName,Ticket:a.Ticket};lsm.saveUserIdentity(b),window.location="/User/Profile"}else $("#divPasswordError").text(a.Message),$("#divPasswordError").show()})},a}(),loglist=function(){function a(){}return a.getExceptionLogList=function(){jshelper.ajaxGet("api/LogData/GetExceptionList",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedExceptionLogID=b.ID,a.pselecteExceptionLogDataRow=b})}if(1===b.Status){var c=document.querySelector("#myloggrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"类型",field:"EventTypeID",width:60},{headerName:"优先级",field:"Priority",width:60},{headerName:"紧急",field:"Severity",width:60},{headerName:"标题",field:"Title",width:160},{headerName:"信息",field:"Message",width:160},{headerName:"创建日期",field:"Timestamp",width:120}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"Log / List",content:"读取异常日志记录失败！错误信息："+b.Message,type:"error"})})},a.getUserLogList=function(){jshelper.ajaxGet("api/LogData/GetUserLogPaged100",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedUserLogID=b.ID,a.pselecteUserLogDataRow=b})}if(1===b.Status){var c=document.querySelector("#myuserloggrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"用户ID",field:"UserID",width:60},{headerName:"登录名称",field:"LoginName",width:60},{headerName:"登录时间",field:"LoginTime",width:160},{headerName:"退出时间",field:"LogoutTime",width:160},{headerName:"IP地址",field:"IPAddress",width:120}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"Log / List",content:"读取用户登录记录失败！错误信息："+b.Message,type:"error"})})},a}(),processlist=function(){function a(){}return a.getProcessList=function(){jshelper.ajaxGet("api/WfData/GetProcessListSimple",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedProcessGUID=b.ProcessGUID,a.pselectedProcessDataRow=b})}if(1===b.Status){var c=document.querySelector("#myprocessgrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"流程GUID",field:"ProcessGUID",width:120},{headerName:"流程名称",field:"ProcessName",width:160},{headerName:"版本",field:"Version",width:40},{headerName:"状态",field:"IsUsing",width:60},{headerName:"创建日期",field:"CreatedDateTime",width:120}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"Process / List",content:"读取流程定义记录失败！错误信息："+b.Message,type:"error"})})},a.getProcessInstanceList=function(){jshelper.ajaxGet("api/WfData/GetProcessInstanceList",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedProcessInstanceID=b.ID,a.pselectedProcessInstanceDataRow=b})}if(1===b.Status){var c=document.querySelector("#myprocessinstancegrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"流程名称",field:"ProcessName",width:160},{headerName:"应用名称",field:"AppName",width:120},{headerName:"状态",field:"ProcessState",width:40},{headerName:"创建日期",field:"CreatedDateTime",width:120},{headerName:"创建用户",field:"CreatedByUserName",width:60},{headerName:"完成日期",field:"EndedDateTime",width:120},{headerName:"完成用户",field:"EndedByUserName",width:60}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"ProcessInstance / List",content:"读取流程实例记录失败！错误信息："+b.Message,type:"error"})})},a.getActivityInstanceList=function(){jshelper.ajaxGet("api/WfData/GetActivityInstanceList",null,function(a){function d(){var a=c.api.getSelectedRows();a.forEach(function(a,b){activityinstancelist.pselectedActivityInstanceID=a.ID,activityinstancelist.pselectedActivityInstanceDataRow=a})}if(1===a.Status){var b=document.querySelector("#myactivityinstancegrid");$(b).empty();var c={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"应用名称",field:"AppName",width:120},{headerName:"活动名称",field:"ActivityName",width:60},{headerName:"状态",field:"ActivityState",width:40},{headerName:"类型",field:"ActivityType",width:40},{headerName:"分配用户",field:"AssignedToUserNames",width:160},{headerName:"创建日期",field:"CreatedDateTime",width:120},{headerName:"创建用户",field:"CreatedByUserName",width:60},{headerName:"完成日期",field:"EndedDateTime",width:120},{headerName:"完成用户",field:"EndedByUserName",width:60}],rowSelection:"single",onSelectionChanged:d};new agGrid.Grid(b,c),c.api.setRowData(a.Entity)}else $.msgBox({title:"ActivityInstance / List",content:"读取活动实例记录失败！错误信息："+a.Message,type:"error"})})},a.getFormList=function(){jshelper.ajaxGet("api/WfData/GetFormListSimple",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedFormID=b.ID,a.pselecteFormDataRow=b})}if(1===b.Status){var c=document.querySelector("#myformgrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"表单名称",field:"EntityName",width:120},{headerName:"表单标题",field:"EntityTitle",width:160},{headerName:"表单编码",field:"EntityCode",width:80},{headerName:"描述",field:"Description",width:160},{headerName:"创建日期",field:"CreatedDate",width:120}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"Form / List",content:"读取表单定义记录失败！错误信息："+b.Message,type:"error"})})},a}(),productlist=function(){function a(){}function b(a){function d(){var a=c.api.getSelectedRows();a.forEach(function(a,b){rolelist.pselectedProductID=a.ID,rolelist.pselectedProductDataRow=a})}somain.displayProgressBar(!0);var b=document.querySelector("#myProductGrid");$(b).empty();var c={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"名称",field:"ProductName",width:120,cssClass:"bg-gray"},{headerName:"编码",field:"ProductCode",width:120,cssClass:"bg-gray"},{headerName:"类型",field:"ProductType",width:160,cssClass:"bg-gray"},{headerName:"单价",field:"UnitPrice",width:160,cssClass:"bg-gray"},{headerName:"创建时间",field:"CreatedDate",width:200,cssClass:"bg-gray",formatter:datetimeFormatter}],rowSelection:"single",onSelectionChanged:d};new agGrid.Grid(b,c),c.api.setRowData(a),somain.displayProgressBar(!1)}return a.mselectedProductID=0,a.mselectedProductRow=null,a.load=function(){jshelper.ajaxGet("/api/product/GetProductList",null,function(a){1==a.Status?b(a.Entity):$.msgBox({title:"Product / List",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.query=function(){var a={};a.ProductType=$("#ddlProductTypeQuery").val(),null!=a.ProductType&&"default"!=a.ProductType&&jshelper.ajaxPost("/soneweb/api/product/query",JSON.stringify(a),function(a){1==a.Status?(b(a.Entity),$("#modelProductQueryForm").modal("hide")):$.msgBox({title:"Product / Query",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.getProductByID=function(){a.mselectedProductID>0&&jshelper.ajaxGet("/soneweb/api/product/Get/"+a.mselectedProductID,null,function(a){if(1==a.Status){var b=a.Entity;$("#txtProductName").val(b.ProductName),$("#ddlProductType").val(b.ProductType),$("#txtProductCode").val(b.ProductCode),$("#txtUnitPrice").val(b.UnitPrice),$("#txtNotes").val(b.Notes)}else $.msgBox({title:"Product / Edit",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.sure=function(){var b={};b.ID=a.mselectedProductID,b.ProductName=$("#txtProductName").val(),b.ProductType=$("#ddlProductType").val(),b.ProductCode=$("#txtProductCode").val(),b.UnitPrice=$("#txtUnitPrice").val(),b.Notes=$("#txtNotes").val(),jshelper.ajaxPost("/soneweb/api/product/save",JSON.stringify(b),function(b){1==b.Status?($.msgBox({title:"Product / Edit",content:"产品记录保存成功！",type:"info"}),a.load()):$.msgBox({title:"Product / Save",content:b.Message,type:"error",buttons:[{value:"Ok"}]})}),$("#modelProductEditForm").modal("hide")},a.delete=function(){0!=a.mselectedProductID&&$.msgBox({title:"Are You Sure",content:"确定要删除产品数据记录吗? ",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(b){"Yes"==b&&jshelper.ajaxGet("/soneweb/api/product/Delete/"+a.mselectedProductID,null,function(b){1==b.Status?($.msgBox({title:"Biz / Product",content:"产品记录已经删除！",type:"info"}),a.load()):$.msgBox({title:"Product / Delete",content:b.Message,type:"error",buttons:[{value:"Ok"}]})})}})},a}(),resourcelist=function(){function a(){}function b(a,b){"edit"===b?(1===a&&$(".resource-type-system").show(),2===a&&$(".resource-type-page").show(),5===a&&$(".resource-type-action").show()):(0===a&&$(".resource-type-system").show(),1===a&&$(".resource-type-page").show(),2===a&&$(".resource-type-action").show())}return a.loadResource=function(){if($(".resource-type").hide(),"add"===somain.activeToolButtonType)$("#txtResourceName").val(""),$("#ddlResourceTypeID").val("0"),$("#txtUrlAction").val(""),$("#txtDataAction").val(""),$("#txtStyleClass").val(""),$("#txtOrderNum").val("");else if("edit"===somain.activeToolButtonType&&""!==a.pselectedResourceID){var c=a.pselectedResourceDataRow;$("#txtResourceName").val(c.ResourceName),$("#ddlResourceTypeID").val(c.ResourceTypeID),$("#txtUrlAction").val(c.UrlAction),$("#txtDataAction").val(c.DataAction),$("#txtStyleClass").val(c.StyleClass),$("#txtOrderNum").val(c.OrderNum)}b(a.pselectedResourceTypeID,somain.activeToolButtonType)},a.getResourceList=function(){jshelper.ajaxGet("api/ResourceData/GetResourceNodeAll",null,function(b){function f(a){return a.node.data.ResourceName}function g(b){var c=b.node;a.pselectedResourceID=c.data.ID,a.pselectedResourceTypeID=c.data.ResourceTypeID,a.pselectedResourceDataRow=c.data}if(1===b.Status){var c={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"资源名称",field:"ResourceName",width:160,cssClass:"bg-gray",cellRenderer:"group",cellRendererParams:{innerRenderer:f}},{headerName:"类型",field:"ResourceTypeID",width:40,cssClass:"bg-gray"},{headerName:"页面URL",field:"UrlAction",width:120,cssClass:"bg-gray"},{headerName:"数据操作",field:"DataAction",width:120,cssClass:"bg-gray"},{headerName:"样式",field:"StyleClass",width:200,cssClass:"bg-gray"},{headerName:"排序",field:"OrderNum",width:60,cssClass:"bg-gray"}],rowSelection:"single",enableColResize:!0,enableSorting:!0,animateRows:!0,rowHeight:30,getNodeChildDetails:function(a){return a.group?{group:!0,name:a.ResourceName,children:a.children,expanded:a.ResourceTypeID<3?"true":"false"}:null},onRowClicked:g},d=document.querySelector("#myresourcegrid");$(d).empty();var e=[];e.push(b.Entity),new agGrid.Grid(d,c),c.api.setRowData(e)}else $.msgBox({title:"Role / List",content:"读取资源记录失败！错误信息："+b.Message,type:"error"})})},a.saveResource=function(){if(""==$("#txtResourceName").val()||""==$("#txtResourceCode").val())return $.msgBox({title:"SlickSafe / Resource",content:"请输入资源基本信息！",type:"alert"}),!1;var b={ID:"0",ResourceName:$("#txtResourceName").val(),ResourceTypeID:$("#ddlResourceTypeID").val(),UrlAction:$("#txtUrlAction").val(),StyleClass:$("#txtStyleClass").val(),OrderNum:$("#txtOrderNum").val()};"edit"===somain.activeToolButtonType?(b.ID=a.pselectedResourceID,b.ParentID=a.pselectedResourceDataRow.ParentID):b.ParentID=a.pselectedResourceID,resourceapi.save(b)},a.delete=function(){$.msgBox({title:"Are You Sure",content:"确实要删除资源记录吗? ",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(b){if("Yes"==b){var c={ID:a.pselectedResourceID};return void resourceapi.delete(c)}}})},a}(),resourceapi=function(){function a(){}return a.save=function(a){jshelper.ajaxPost("api/ResourceData/SaveResource",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"SlickSafe / Resource",content:"已经成功保存资源数据！",type:"info"}),resourcelist.getResourceList()):$.msgBox({title:"SlickSafe / Resource",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.delete=function(a){jshelper.ajaxPost("api/ResourceData/DeleteResource",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"SlickSafe / Resource",content:"资源记录已经删除！",type:"info"}),resourcelist.getResourceList()):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a}(),rolelist=function(){function a(){}return a.pselectedRoleID="",a.pselectedRoleDataRow=null,a.getRoleList=function(){jshelper.ajaxGet("api/RoleData/GetRoleAll",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedRoleID=b.ID,a.pselectedRoleDataRow=b})}if(1===b.Status){var c=document.querySelector("#myrolegrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"角色名称",field:"RoleName",width:120,cssClass:"bg-gray"},{headerName:"角色代码",field:"RoleCode",width:160,cssClass:"bg-gray"}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"Role / List",content:"读取角色记录失败！错误信息："+b.Message,type:"error"})})},a.loadRole=function(){if("edit"===somain.activeToolButtonType&&""!=a.pselectedRoleID){var b=a.pselectedRoleDataRow;$("#txtRoleName").val(b.RoleName),$("#txtRoleCode").val(b.RoleCode)}else $("#txtRoleName").val(""),$("#txtRoleCode").val("")},a.editRole=function(){var b=a.pselectedRoleDataRow;if(null==b)return $.msgBox({title:"SlickSafe / Role",content:"请先选择角色记录！",type:"alert"}),!1},a.saveRole=function(){if(""==$("#txtRoleName").val()||""==$("#txtRoleCode").val())return $.msgBox({title:"SlickSafe / Role",content:"请输入角色基本信息！",type:"alert"}),!1;var b={ID:"0",RoleName:$("#txtRoleName").val(),RoleCode:$("#txtRoleCode").val()};"edit"===somain.activeToolButtonType&&(b.ID=a.pselectedRoleID),roleapi.save(b)},a.delete=function(){$.msgBox({title:"Are You Sure",content:"确实要删除角色记录吗? ",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(b){if("Yes"==b){var c={ID:a.pselectedRoleID};return void roleapi.delete(c)}}})},a}(),roleapi=function(){function a(){}return a.save=function(a){jshelper.ajaxPost("api/RoleData/SaveRole",JSON.stringify(a),function(a){1==a.Status?$.msgBox({title:"SlickSafe / Role",content:"角色记录已经成功保存！",type:"info"}):$.msgBox({title:"SlickSafe / Role",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.delete=function(a){jshelper.ajaxPost("api/RoleData/DeleteRole",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"SlickSafe / Role",content:"角色记录已经删除！",type:"info"}),rolelist.getRoleList()):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a}(),rolepermissionlist=function(){function a(){}function b(b){m(!0);var d={RoleID:b};jshelper.ajaxPost("api/ResourceData/GetRoleResourceList",JSON.stringify(d),function(b){if(1===b.Status){var d=[],e=null,f=b.Entity;$.each(f,function(a,b){e={id:b.ID,pId:b.ParentID,name:b.ResourceName,permission:b.PermissionType,open:!0},d.push(e)});var g=$("#myroleresourcetree");a.pmztree=$.fn.zTree.init(g,c(),d)}else $.msgBox({title:"Permission / List",content:"读取角色资源权限数据失败！错误信息："+b.Message,type:"error"})})}function c(){var a={check:{enable:!1},view:{addDiyDom:d,dblClickExpand:!1,showLine:!0,selectedMulti:!1},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"pId",rootPId:""}}};return a}function d(a,b){if("root"!==b.type){var c="",d=$("#"+b.tId+"_span"),f=null,g=null,h="chkBoxR9Y7_",j=h+"A_"+b.id,k=h+"D_"+b.id;$("#"+j).length>0||$("#"+k).length>0||(c+="<label><input type='checkbox' data-parent='"+b.pId+"' class='checkBoxPermission checkBoxAllowed' id='"+j+"' title='允许' ></label>",c+="<label style='margin-left:25px;'><input type='checkbox' data-parent='"+b.pId+"' class='checkBoxPermission checkBoxDenied' id='"+k+"' title='拒绝' ><label>",c="<label style='margin-left:60px'>"+c+"</label>",d.after(c),f=$("#"+j),f&&f.bind("change",function(){e(f,h,b.id,$(this).data("parent"))}),g=$("#"+k),g&&g.bind("change",function(){i(g,h,b)}),1===b.permission?$(f).attr("checked",!0):b.permission===-1&&$(g).attr("checked",!0))}}function e(a,b,c,d){if($(a).is(":checked")!==!1)return f(b,c)?($.msgBox({title:"RoleResource / List",content:"已经选择了拒绝权限，请确认要重新授权许可吗？",type:"confirm",success:function(d){if("Yes"===d){var e=$("#"+b+"D_"+c);e&&$(e).is(":checked")===!0&&$(e).attr("checked",!1)}else $(a).attr("checked",!1)}}),!1):g(b,d)?($.msgBox({title:"RoleResource / List",content:"已经有上级拒绝权限存在，不能再次选择！",type:"alert"}),$(a).attr("checked",!1),!1):void h(b,d)}function f(a,b){var c=$("#"+a+"D_"+b);return!(!c||$(c).is(":checked")!==!0)}function g(a,b){var c=$("#"+a+"D_"+b);if(c&&$(c).is(":checked")===!0)return!0;var d=$(c).data("parent");return d>0&&g(a,d)}function h(a,b){var c=$("#"+a+"A_"+b);c&&$(c).is(":checked")===!1&&$(c).attr("checked",!0);var d=$(c).data("parent");d>0&&h(a,d)}function i(a,b,c){var d=c.id;$(a).is(":checked")!==!1&&(j(b,d)===!0?$.msgBox({title:"RoleResource / List",content:"当前权限为允许，请确认要修改为拒绝吗？",type:"confirm",success:function(d){"Yes"===d?k(b,c):$(a).attr("checked",!1)}}):k(b,c))}function j(a,b){var c=$("#"+a+"A_"+b);return!(!c||$(c).is(":checked")!==!0)}function k(a,b){var c=b.id,d=$("#"+a+"A_"+c);d&&$(d).attr("checked",!1);var e=$("#"+a+"D_"+c);e&&$(e).attr("checked",!0);var f=b.children;f&&f.length>0&&$.each(f,function(b,c){k(a,c)})}function l(a){var b="",c=null,d=[];return $.each($(".checkBoxPermission.checkBoxAllowed"),function(e,f){$(f).is(":checked")===!0&&(b=f.id.substring(f.id.lastIndexOf("_")+1),c={RoleID:a,ResourceID:b,PermissionType:1},d.push(c))}),$.each($(".checkBoxPermission.checkBoxDenied"),function(e,f){$(f).is(":checked")===!0&&(b=f.id.substring(f.id.lastIndexOf("_")+1),c={RoleID:a,ResourceID:b,PermissionType:-1},d.push(c))}),d}function m(a){a===!0?$("#treeContainerRoleResource").show():$("#treeContainerRoleResource").hide()}return a.getRoleList=function(){jshelper.ajaxGet("api/RoleData/GetRoleAll",null,function(c){function f(c){var d=c.node;a.pselectedRoleID=d.data.ID,a.pselectedRoleDataRow=d.data,b(a.pselectedRoleID)}if(1===c.Status){var d=document.querySelector("#myrolepermissiongrid");$(d).empty();var e={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"角色名称",field:"RoleName",width:140,cssClass:"bg-gray"},{headerName:"角色代码",field:"RoleCode",width:140,cssClass:"bg-gray"}],rowSelection:"single",onRowClicked:f};new agGrid.Grid(d,e),e.api.setRowData(c.Entity)}else $.msgBox({title:"Permission / List",content:"读取角色记录失败！错误信息："+c.Message,type:"error"})})},a.save=function(){var b=l(a.pselectedRoleID);if(b.length>0)jshelper.ajaxPost("api/ResourceData/SaveRoleResourceList",JSON.stringify(b),function(a){1===a.Status?$.msgBox({title:"RoleResoure / List",content:"保存角色资源权限记录成功！",type:"info"}):$.msgBox({title:"RoleResoure / List",content:"保存角色资源权限记录失败！错误信息："+a.Message,type:"error"})});else{var c={RoleID:a.pselectedRoleID};jshelper.ajaxPost("api/ResourceData/ClearRoleResourceList",JSON.stringify(c),function(a){1===a.Status?$.msgBox({title:"RoleResoure / List",content:"清除角色资源权限记录成功！",type:"info"}):$.msgBox({title:"RoleResoure / List",content:"清除角色资源权限记录失败！错误信息："+a.Message,type:"error"})})}},a.cancel=function(){m(!1)},a}(),roleusertree=function(){function a(){}function b(a,b){if("root"!==b.type){var c="",d=$("#"+b.tId+"_span"),e=null,i=null;if("role"===b.type){if(b.editNameFlag||$("#addBtn_"+b.tId).length>0)return;if(c+="<span class='button add' id='addBtn_"+b.tId+"' title='添加用户' ></span>",d.after(c),e=$("#addBtn_"+b.tId),e&&e.bind("click",function(){f(b.roleId)}),b.editNameFlag||$("#rmvBtn_"+b.tId).length>0)return;c="<span class='button remove' id='rmvBtn_"+b.tId+"' title='全部删除用户' onfocus='this.blur();'></span>",d.after(c),i=$("#rmvBtn_"+b.tId),i&&i.bind("click",function(){g(b.roleId)})}else if("user"===b.type){if(b.editNameFlag||$("#rmvBtn_"+b.tId).length>0)return;c="<span class='button remove' id='rmvBtn_"+b.tId+"' title='删除用户' onfocus='this.blur();'></span>",d.after(c),i=$("#rmvBtn_"+b.tId),i&&i.bind("click",function(){h(b.userId,b.roleId)})}}}function c(a,b){$("#addBtn_"+b.tId).unbind().remove(),$("#rmvBtn_"+b.tId).unbind().remove()}function d(){var a={check:{enable:!0},view:{addHoverDom:b,removeHoverDom:c,dblClickExpand:!1,showLine:!0,selectedMulti:!1},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"pId",rootPId:""}},callback:{beforeClick:function(a,b){var c=$.fn.zTree.getZTreeObj("myroleusertree");return!b.isParent||(c.expandNode(b),!1)},onClick:function(a,b,c){}}};return a}function e(a,b){b.RoleID>0&&b.UserID>0&&roleuserapi.addRoleUser(b)}function f(a){userlistdialog.pselectedRoleID=a,somain.displayProgressBar(!0),BootstrapDialog.show({title:"User",message:$("<div></div>").load("User/Dialog",function(){somain.displayProgressBar(!1)})})}function g(a){$.msgBox({title:"Are You Sure",content:"确实要删除角色下的全部用户记录吗? 请您慎重操作!!!",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(b){if("Yes"==b){var c={UserID:-1,RoleID:a};return void roleuserapi.delete(c)}}})}function h(a,b){$.msgBox({title:"Are You Sure",content:"确实要删除角色下的用户记录吗? ",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(c){if("Yes"==c){var d={UserID:a,RoleID:b};return void roleuserapi.delete(d)}}})}return a.pmztree=null,a.getRoleUserTree=function(){var b=[{id:0,pId:-1,name:"角色列表",type:"root",open:!0}];jshelper.ajaxGet("api/RoleData/GetRoleUserAll",null,function(c){if(1==c.Status){var f=null,g=null,h=0,i=c.Entity;$.each(i,function(a,c){var d="r"+c.RoleID;h!==d&&(f={id:d,pId:0,roleId:c.RoleID,name:c.RoleName,type:"role",open:!1},b.push(f),h=d),0!==c.ID&&(g={id:"ru"+c.ID,pId:h,userId:c.UserID,name:c.UserName,roleId:c.RoleID,type:"user",open:!1},b.push(g))});var j=$("#myroleusertree");a.pmztree=$.fn.zTree.init(j,d(),b),userlistdialog.onUserSelected4Adding.subscribe(e)}})},a}(),roleuserapi=function(){function a(){}return a.addRoleUser=function(a){jshelper.ajaxPost("api/RoleData/AddRoleUser",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"SlickOne / Role",content:"已经成功添加用户到该角色！",type:"info"}),roleusertree.getRoleUserTree()):$.msgBox({title:"SlickOne / Role",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.delete=function(a){jshelper.ajaxPost("api/RoleData/DeleteRoleUser",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"SlickOne / Role",content:"角色下的用户记录已经删除！",type:"info"}),roleusertree.getRoleUserTree()):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a}(),tasklist=function(){function a(){}return a}(),userlist=function(){function a(){}return a.pselectedUserID="",a.pselectedUserDataRow=null,a.getUserList=function(){jshelper.ajaxGet("api/RoleData/GetUserAll",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedUserID=b.ID,a.pselectedUserDataRow=b})}if(1===b.Status){var c=document.querySelector("#myusergrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"登录名称",field:"LoginName",width:120,cssClass:"bg-gray"},{headerName:"用户名称",field:"UserName",width:120,cssClass:"bg-gray"},{headerName:"状态",field:"Status",width:60,cssClass:"bg-gray"},{headerName:"电子邮件",field:"EMail",width:180,cssClass:"bg-gray"}],rowSelection:"single",onSelectionChanged:e};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}else $.msgBox({title:"User / List",content:"读取用户记录失败！错误信息："+b.Message,type:"error"})})},a.loadUser=function(){if("edit"===somain.activeToolButtonType&&""!=a.pselectedUserID){var b=a.pselectedUserDataRow;$("#txtUserName").val(b.UserName)}else $("#txtUserName").val("")},a.editUser=function(){var b=a.pselectedUserDataRow;return null==b?($.msgBox({title:"SlickSafe / User",content:"请先选择用户记录！",type:"alert"}),!1):void BootstrapDialog.show({title:"user",message:$("<div></div>").load("user/edit")})},a.saveUser=function(){if(""==$("#txtUserName").val()||""==$("#txtUserCode").val())return $.msgBox({title:"SlickSafe / User",content:"请输入角色基本信息！",type:"alert"}),!1;var b={ID:"0",UserName:$("#txtUserName").val(),UserCode:$("#txtUserCode").val()};"edit"===somain.activeToolButtonType&&(b.ID=a.pselectedUserID),userapi.save(b)},a.delete=function(){$.msgBox({title:"Are You Sure",content:"数据演示版本，暂不提供删除功能。",type:"info"})},a.sure=function(){$("#modelRoleListForm").modal("hide"),""!=a.pselecteUserID},a}(),userapi=function(){function a(){}return a.save=function(a){jshelper.ajaxPost("api/RoleData/SaveUser",JSON.stringify(a),function(a){1==a.Status?$.msgBox({title:"SlickSafe / User",content:"用户记录成功保存！",type:"info"}):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.delete=function(a){jshelper.ajaxPost("api/RoleData/DeleteUser",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"SlickSafe / User",content:"用户记录已经删除！",type:"info"}),userlist.getUserList()):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a}(),userlistdialog=function(){function a(){}return a.pselectedRoleID="",a.pselectedUserID="",a.pselectedUserDataRow=null,a.onUserSelected4Adding=new slick.Event,a.getUserList=function(){jshelper.ajaxGet("api/RoleData/GetUserAll",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedUserID=b.ID,a.pselectedUserDataRow=b})}if(1===b.Status){var c=document.querySelector("#myuserlistdialoggrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"登录名称",field:"LoginName",width:120,cssClass:"bg-gray"},{headerName:"用户名称",field:"UserName",width:120,cssClass:"bg-gray"}],rowSelection:"single",onSelectionChanged:e
};new agGrid.Grid(c,d),d.api.setRowData(b.Entity)}})},a.sure=function(){slick.trigger(a.onUserSelected4Adding,{UserID:a.pselectedUserID,RoleID:a.pselectedRoleID})},a.cancel=function(){a.pselectedUserID="",a.pselectedUserDataRow=null},a}(),userpermissionlist=function(){function a(){}function b(b){m(!0);var d={UserID:b};jshelper.ajaxPost("api/ResourceData/RetrieveUserResourceList",JSON.stringify(d),function(b){if(1===b.Status){var d=[],e=null,f=b.Entity;$.each(f,function(a,b){e={id:b.ID,pId:b.ParentID,name:b.ResourceName,isAllowInherited:b.IsAllowInherited,isAllowSelf:b.IsAllowSelf,isDenyInherited:b.IsDenyInherited,isDenySelf:b.IsDenySelf,open:!0},d.push(e)});var g=$("#myuserresourcetree");a.pmztree=$.fn.zTree.init(g,c(),d)}else $.msgBox({title:"UserResource / List",content:"读取用户资源权限数据失败！错误信息："+b.Message,type:"error"})})}function c(){var a={check:{enable:!1},view:{addDiyDom:d,dblClickExpand:!1,showLine:!0,selectedMulti:!1},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"pId",rootPId:""}}};return a}function d(a,b){if("root"!==b.type){var c="",d=$("#"+b.tId+"_span"),f=null,g=null,h=null,j=null,k="chkBoxT0Z6_",l=k+"A_I_"+b.id,m=k+"A_S_"+b.id,n=k+"D_I_"+b.id,o=k+"D_S_"+b.id;$("#"+l).length>0||$("#"+n).length>0||(c+="<label><input type='checkbox' data-parent='"+b.pId+"' class='checkBoxPermission checkBoxAllowed checkBoxAllowedInherited' id='"+l+"' title='允许(继承)' disabled ></label>",c+="<label style='margin-left:10px;'><input type='checkbox' data-parent='"+b.pId+"' class='checkBoxPermission checkBoxAllowed checkBoxAllowedSelf' id='"+m+"' title='允许(自有)' ></label>",c+="<label style='margin-left:50px;'><input type='checkbox' data-parent='"+b.pId+"' class='checkBoxPermission checkBoxDenied checkBoxDeniedInherited' id='"+n+"' title='拒绝(继承)' disabled ><label>",c+="<label style='margin-left:10px;'><input type='checkbox' data-parent='"+b.pId+"' class='checkBoxPermission checkBoxDenied checkBoxDeniedSelf' id='"+o+"' title='拒绝(自有)' ><label>",c="<label style='margin-left:60px'>"+c+"</label>",d.after(c),f=$("#"+l),g=$("#"+m),h=$("#"+n),j=$("#"+o),1===b.isAllowInherited&&$(f).attr("checked",!0),1===b.isAllowSelf&&$(g).attr("checked",!0),1===b.isDenyInherited&&$(h).attr("checked",!0),1===b.isDenySelf&&$(j).attr("checked",!0),g&&g.bind("change",function(){e(g,k,b,$(this).data("parent"))}),j&&j.bind("change",function(){i(j,k,b,$(this).data("parent"))}))}}function e(a,b,c,d){if($(a).is(":checked")!==!1){var e=c.id;return f(b,e)?($.msgBox({title:"UserResource / List",content:"已经选择了拒绝权限，请确认要重新授权许可吗？",type:"confirm",success:function(c){if("Yes"===c){var d=$("#"+b+"D_S_"+e);d&&$(d).is(":checked")===!0&&$(d).attr("checked",!1)}else $(a).attr("checked",!1)}}),!1):g(b,d)?($.msgBox({title:"UserResource / List",content:"已经有上级拒绝权限存在，不能再次选择！",type:"alert"}),$(a).attr("checked",!1),!1):void h(b,c,d)}}function f(a,b){var c=$("#"+a+"D_S_"+b);return!(!c||$(c).is(":checked")!==!0)}function g(a,b){var c=$("#"+a+"D_S_"+b);if(c&&$(c).is(":checked")===!0)return!0;var d=$(c).data("parent");return d>0&&g(a,d)}function h(a,b,c){var d=$("#"+a+"A_S_"+c);d&&$(d).is(":checked")===!1&&$(d).attr("checked",!0);var e=$(d).data("parent");e>0&&h(a,b.parent,e)}function i(a,b,c,d){var e=c.id;$(a).is(":checked")!==!1&&(j(b,e)===!0?$.msgBox({title:"UserResource / List",content:"当前权限为允许，请确认要修改为拒绝吗？",type:"confirm",success:function(d){"Yes"===d?k(b,c):$(a).attr("checked",!1)}}):k(b,c))}function j(a,b){var c=$("#"+a+"A_S_"+b);return!(!c||$(c).is(":checked")!==!0)}function k(a,b){var c=b.id,d=$("#"+a+"A_S_"+c);d&&$(d).attr("checked",!1);var e=$("#"+a+"D_S_"+c);e&&$(e).attr("checked",!0);var f=b.children;f&&f.length>0&&$.each(f,function(b,c){k(a,c)})}function l(a){var b="",c=null,d=[];return $.each($(".checkBoxPermission.checkBoxAllowed.checkBoxAllowedSelf"),function(e,f){b=f.id.substring(f.id.lastIndexOf("_")+1),$(f).is(":checked")===!0&&(c={UserID:a,ResourceID:b,PermissionType:1,IsInherited:-1},d.push(c))}),$.each($(".checkBoxPermission.checkBoxDenied.checkBoxDeniedSelf"),function(e,f){b=f.id.substring(f.id.lastIndexOf("_")+1),$(f).is(":checked")===!0&&(c={UserID:a,ResourceID:b,PermissionType:-1,IsInherited:-1},d.push(c))}),d}function m(a){a===!0?$("#treeContainerUserResource").show():$("#treeContainerUserResource").hide()}return a.getUserList=function(){jshelper.ajaxGet("api/RoleData/GetUserAll",null,function(c){function f(c){var d=c.node;a.pselectedUserID=d.data.ID,a.pselectedUserDataRow=d.data,b(a.pselectedUserID)}if(1===c.Status){var d=document.querySelector("#myuserpermissiongrid");$(d).empty();var e={columnDefs:[{headerName:"ID",field:"ID",width:40,cssClass:"bg-gray"},{headerName:"用户名称",field:"UserName",width:120,cssClass:"bg-gray"}],rowSelection:"single",onRowClicked:f};new agGrid.Grid(d,e),e.api.setRowData(c.Entity)}else $.msgBox({title:"User / List",content:"读取用户记录失败！错误信息："+c.Message,type:"error"})})},a.save=function(){var b=l(a.pselectedUserID);if(b.length>0)jshelper.ajaxPost("api/ResourceData/SaveUserResourceList",JSON.stringify(b),function(a){1===a.Status?$.msgBox({title:"UserResoure / List",content:"保存用户资源权限记录成功！",type:"info"}):$.msgBox({title:"UserResoure / List",content:"保存用户资源权限记录失败！错误信息："+a.Message,type:"error"})});else{var c={UserID:a.pselectedUserID};jshelper.ajaxPost("api/ResourceData/ClearUserResourceList",JSON.stringify(c),function(a){1===a.Status?$.msgBox({title:"UserResoure / List",content:"清除用户资源自有权限记录成功！",type:"info"}):$.msgBox({title:"RoleResoure / List",content:"清除用户资源自有权限记录失败！错误信息："+a.Message,type:"error"})})}},a.cancel=function(){m(!1)},a}();